<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD Trading Bot Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.5s;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-running { 
            background: #00ff00; 
            color: black;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        .status-stopped { 
            background: #ff0000; 
            color: white;
            animation: none;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .price-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: priceUpdate 0.5s;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .balance {
            font-size: 2em;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .trade-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 20px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-buy {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: black;
        }
        
        .btn-buy:hover {
            background: linear-gradient(135deg, #00cc00 0%, #009900 100%);
        }
        
        .btn-sell {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
        }
        
        .btn-sell:hover {
            background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        }
        
        .indicator {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .indicator:last-child {
            border-bottom: none;
        }
        
        .signal-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
            text-align: center;
            width: 100%;
        }
        
        .signal-hold { 
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            color: black; 
        }
        .signal-buy { 
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: black;
            animation: signalPulse 1s infinite;
        }
        .signal-sell { 
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            animation: signalPulse 1s infinite;
        }
        
        @keyframes signalPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.6); }
        }
        
        .trade-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trade-history::-webkit-scrollbar {
            width: 8px;
        }
        
        .trade-history::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .trade-history::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .trade-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .trade-buy { border-color: #00ff00; }
        .trade-sell { border-color: #ff0000; }
        
        .last-update {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .connected {
            background: #00ff00;
            color: black;
        }
        
        .disconnected {
            background: #ff0000;
            color: white;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .price-display { font-size: 2em; }
            .balance { font-size: 1.5em; }
            .btn { font-size: 1.1em; padding: 15px; }
            .grid { grid-template-columns: 1fr; }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
        }
        
        .emoji-large {
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">
        ‚è≥ Connecting...
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ü§ñ XAUUSD Trading Bot Dashboard</h1>
            <span id="status-badge" class="status-badge status-stopped">‚è∏Ô∏è INITIALIZING</span>
        </div>
        
        <div class="grid">
            <!-- Price & Balance Card -->
            <div class="card">
                <h2>üí∞ Account Overview</h2>
                <div class="balance" id="balance">$100,000.00</div>
                <div class="price-display" id="price">Loading...</div>
                <div style="text-align: center; opacity: 0.8;">
                    Spread: $<span id="spread">0.00</span>
                </div>
            </div>
            
            <!-- Trading Controls Card -->
            <div class="card">
                <h2>‚ö° Manual Trading</h2>
                <div style="text-align: center;">
                    <div class="signal-badge signal-hold" id="signal-badge">HOLD</div>
                </div>
                <div class="trade-buttons">
                    <button class="btn btn-buy" onclick="executeTrade('buy')">
                        üü¢ BUY<br><small style="font-size:0.7em;">0.01 LOT</small>
                    </button>
                    <button class="btn btn-sell" onclick="executeTrade('sell')">
                        üî¥ SELL<br><small style="font-size:0.7em;">0.01 LOT</small>
                    </button>
                </div>
            </div>
            
            <!-- SMC Indicators Card -->
            <div class="card">
                <h2>üìä SMC Indicators</h2>
                <div class="indicator">
                    <span>Market Structure:</span>
                    <strong id="market-structure">NEUTRAL</strong>
                </div>
                <div class="indicator">
                    <span>Zone:</span>
                    <strong id="zone">EQUILIBRIUM</strong>
                </div>
                <div class="indicator">
                    <span>Session:</span>
                    <strong id="session">CLOSED</strong>
                </div>
                <div class="indicator">
                    <span>FVG Bullish:</span>
                    <strong id="fvg-bullish">‚ùå</strong>
                </div>
                <div class="indicator">
                    <span>FVG Bearish:</span>
                    <strong id="fvg-bearish">‚ùå</strong>
                </div>
                <div class="indicator">
                    <span>Last BOS:</span>
                    <strong id="bos">None</strong>
                </div>
            </div>
            
            <!-- Technical Levels Card -->
            <div class="card">
                <h2>üìà Technical Levels</h2>
                <div class="indicator">
                    <span>EMA200:</span>
                    <strong id="ema200">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>MA20:</span>
                    <strong id="ma20">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>MA50:</span>
                    <strong id="ma50">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>Support:</span>
                    <strong id="support">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>Resistance:</span>
                    <strong id="resistance">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>ATR:</span>
                    <strong id="atr">$0.00</strong>
                </div>
            </div>
        </div>
        
        <!-- Trade History Card (Full Width) -->
        <div class="card">
            <h2>üìú Recent Trades</h2>
            <div class="trade-history" id="trade-history">
                <div class="loading">
                    <span class="emoji-large">‚è≥</span>
                    Waiting for trade data...
                </div>
            </div>
        </div>
        
        <div class="last-update" id="last-update">
            Last update: Connecting...
        </div>
    </div>
    
    <script>
        let ws;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const API_URL = window.location.origin;
        
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                console.log('‚úÖ Connected to bot');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus(false);
            };
            
            ws.onclose = () => {
                console.log('‚ùå Disconnected from bot');
                updateConnectionStatus(false);
                
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    console.log(`Reconnecting... Attempt ${reconnectAttempts}`);
                    setTimeout(connectWebSocket, 3000);
                }
            };
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = '‚úÖ Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = '‚ùå Disconnected';
            }
        }
        
        function updateDashboard(data) {
            // Status badge
            const statusBadge = document.getElementById('status-badge');
            if (data.running) {
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'üü¢ RUNNING';
            } else {
                statusBadge.className = 'status-badge status-stopped';
                statusBadge.textContent = '‚è∏Ô∏è STOPPED';
            }
            
            // Price & Balance
            document.getElementById('balance').textContent = `$${data.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            if (data.current_price && data.current_price.bid) {
                document.getElementById('price').textContent = `$${data.current_price.bid.toFixed(2)}`;
                document.getElementById('spread').textContent = data.current_price.spread.toFixed(2);
            }
            
            // Signal
            const signalBadge = document.getElementById('signal-badge');
            const signal = data.last_signal || 'HOLD';
            signalBadge.textContent = signal;
            signalBadge.className = `signal-badge signal-${signal.toLowerCase()}`;
            
            // SMC Indicators
            document.getElementById('market-structure').textContent = data.market_structure || 'NEUTRAL';
            document.getElementById('zone').textContent = data.zone || 'EQUILIBRIUM';
            document.getElementById('session').textContent = data.smc_indicators?.session || 'CLOSED';
            document.getElementById('fvg-bullish').textContent = data.smc_indicators?.fvg_bullish ? '‚úÖ' : '‚ùå';
            document.getElementById('fvg-bearish').textContent = data.smc_indicators?.fvg_bearish ? '‚úÖ' : '‚ùå';
            document.getElementById('bos').textContent = data.smc_indicators?.bos || 'None';
            
            // Technical Levels
            const levels = data.technical_levels || {};
            document.getElementById('ema200').textContent = `$${(levels.ema200 || 0).toFixed(2)}`;
            document.getElementById('ma20').textContent = `$${(levels.ma20 || 0).toFixed(2)}`;
            document.getElementById('ma50').textContent = `$${(levels.ma50 || 0).toFixed(2)}`;
            document.getElementById('support').textContent = `$${(levels.support || 0).toFixed(2)}`;
            document.getElementById('resistance').textContent = `$${(levels.resistance || 0).toFixed(2)}`;
            document.getElementById('atr').textContent = `$${(levels.atr || 0).toFixed(2)}`;
            
            // Trade History
            if (data.trades && data.trades.length > 0) {
                const historyHTML = data.trades.slice(0, 10).map(trade => `
                    <div class="trade-item trade-${trade.type.toLowerCase()}">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>#${trade.id} ${trade.type}</strong>
                            <span>${trade.lot_size} lots</span>
                        </div>
                        <div style="margin-top: 5px;">
                            Entry: $${trade.entry.toFixed(2)}
                        </div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                            ${trade.time} ‚Ä¢ ${trade.status}
                        </div>
                    </div>
                `).join('');
                document.getElementById('trade-history').innerHTML = historyHTML;
            } else {
                document.getElementById('trade-history').innerHTML = `
                    <div class="loading">
                        <span class="emoji-large">üìä</span>
                        No trades yet. Monitoring market...
                    </div>
                `;
            }
            
            // Last update
            document.getElementById('last-update').textContent = `Last update: ${data.last_update || 'Just now'}`;
        }
        
        async function executeTrade(type) {
            const confirmed = confirm(`üîî Execute ${type.toUpperCase()} trade for 0.01 lots?\n\nThis will send a manual trade order.`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_URL}/api/trade/manual?trade_type=${type}&lot_size=0.01`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`‚úÖ ${type.toUpperCase()} trade executed successfully!\n\nEntry: $${result.trade.entry.toFixed(2)}\nLot Size: ${result.trade.lot_size}`);
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error executing trade: ${error.message}`);
                console.error('Trade error:', error);
            }
        }
        
        // Fallback polling if WebSocket fails
        async function pollStatus() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                try {
                    const response = await fetch(`${API_URL}/api/status`);
                    const data = await response.json();
                    updateDashboard(data);
                    updateConnectionStatus(true);
                } catch (error) {
                    console.error('Polling error:', error);
                    updateConnectionStatus(false);
                }
            }
        }
        
        // Initialize
        connectWebSocket();
        setInterval(pollStatus, 5000); // Poll every 5 seconds as backup
        
        // Prevent page from sleeping on mobile
        if ('wakeLock' in navigator) {
            let wakeLock = null;
            const requestWakeLock = async () => {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.log('Wake Lock error:', err);
                }
            };
            requestWakeLock();
        }
    </script>
</body>
</html>
