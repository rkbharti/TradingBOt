<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD Trading Bot Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.5s;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .status-running { 
            background: #00ff00; 
            color: black;
            box-shadow: 0 0 20px rgba(0,255,0,0.5);
        }
        .status-stopped { 
            background: #ff0000; 
            color: white;
            animation: none;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        
        .price-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: priceUpdate 0.5s;
        }
        
        @keyframes priceUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .balance {
            font-size: 2em;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .pnl-display {
            text-align: center;
            font-size: 1.3em;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .pnl-positive { color: #00ff00; }
        .pnl-negative { color: #ff6b6b; }
        
        .trade-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 20px;
            font-size: 1.3em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-buy {
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: black;
        }
        
        .btn-buy:hover {
            background: linear-gradient(135deg, #00cc00 0%, #009900 100%);
        }
        
        .btn-sell {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
        }
        
        .btn-sell:hover {
            background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        }
        
        .indicator {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .indicator:last-child {
            border-bottom: none;
        }
        
        .signal-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            margin: 10px 0;
            text-align: center;
            width: 100%;
        }
        
        .signal-hold { 
            background: linear-gradient(135deg, #ffaa00 0%, #ff8800 100%);
            color: black; 
        }
        .signal-buy { 
            background: linear-gradient(135deg, #00ff00 0%, #00cc00 100%);
            color: black;
            animation: signalPulse 1s infinite;
        }
        .signal-sell { 
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            color: white;
            animation: signalPulse 1s infinite;
        }
        
        @keyframes signalPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.6); }
        }
        
        .trade-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .trade-history::-webkit-scrollbar {
            width: 8px;
        }
        
        .trade-history::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        
        .trade-history::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        .trade-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .trade-buy { border-color: #00ff00; }
        .trade-sell { border-color: #ff0000; }
        .trade-open { background: rgba(0, 255, 0, 0.1); }
        .trade-signal { background: rgba(255, 165, 0, 0.1); }
        
        .last-update {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .connected {
            background: #00ff00;
            color: black;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        
        .disconnected {
            background: #ff0000;
            color: white;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .price-display { font-size: 2em; }
            .balance { font-size: 1.5em; }
            .btn { font-size: 1.1em; padding: 15px; }
            .grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
        }
        
        .emoji-large {
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
        
        .update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            margin-left: 10px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connection-status">
        ‚è≥ Connecting...
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ü§ñ XAUUSD Trading Bot Dashboard</h1>
            <span id="status-badge" class="status-badge status-stopped">‚è∏Ô∏è INITIALIZING</span>
        </div>
        
        <div class="grid">
            <!-- Price & Balance Card -->
            <div class="card">
                <h2>üí∞ Account Overview</h2>
                <div class="balance" id="balance">$100,000.00</div>
                <div class="pnl-display" id="pnl-display">
                    P&L: <span id="pnl">$0.00</span>
                </div>
                <div class="price-display" id="price">Loading...</div>
                <div style="text-align: center; opacity: 0.8;">
                    Bid: $<span id="bid">0.00</span> | Ask: $<span id="ask">0.00</span><br>
                    Spread: $<span id="spread">0.00</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Open Positions</div>
                        <div class="stat-value" id="open-positions">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Session</div>
                        <div class="stat-value" id="session-mini">-</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Structure</div>
                        <div class="stat-value" id="structure-mini">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Trading Controls Card -->
            <div class="card">
                <h2>‚ö° Manual Trading</h2>
                <div style="text-align: center;">
                    <div class="signal-badge signal-hold" id="signal-badge">HOLD</div>
                </div>
                <div class="trade-buttons">
                    <button class="btn btn-buy" onclick="executeTrade('buy')">
                        üü¢ BUY<br><small style="font-size:0.7em;">0.01 LOT</small>
                    </button>
                    <button class="btn btn-sell" onclick="executeTrade('sell')">
                        üî¥ SELL<br><small style="font-size:0.7em;">0.01 LOT</small>
                    </button>
                </div>
            </div>
            
            <!-- SMC Indicators Card -->
            <div class="card">
                <h2>üìä SMC Indicators</h2>
                <div class="indicator">
                    <span>Market Structure:</span>
                    <strong id="market-structure">NEUTRAL</strong>
                </div>
                <div class="indicator">
                    <span>Zone:</span>
                    <strong id="zone">EQUILIBRIUM</strong>
                </div>
                <div class="indicator">
                    <span>Session:</span>
                    <strong id="session">CLOSED</strong>
                </div>
                <div class="indicator">
                    <span>FVG Bullish:</span>
                    <strong id="fvg-bullish">‚ùå</strong>
                </div>
                <div class="indicator">
                    <span>FVG Bearish:</span>
                    <strong id="fvg-bearish">‚ùå</strong>
                </div>
                <div class="indicator">
                    <span>Last BOS:</span>
                    <strong id="bos">None</strong>
                </div>
            </div>
            
            <!-- Technical Levels Card -->
            <div class="card">
                <h2>üìà Technical Levels</h2>
                <div class="indicator">
                    <span>EMA200:</span>
                    <strong id="ema200">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>MA20:</span>
                    <strong id="ma20">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>MA50:</span>
                    <strong id="ma50">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>Support:</span>
                    <strong id="support">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>Resistance:</span>
                    <strong id="resistance">$0.00</strong>
                </div>
                <div class="indicator">
                    <span>ATR:</span>
                    <strong id="atr">$0.00</strong>
                </div>
            </div>
        </div>
        
        <!-- Trade History Card (Full Width) -->
        <div class="card">
            <h2>üìú Recent Trades <span class="update-indicator" id="update-indicator"></span></h2>
            <div class="trade-history" id="trade-history">
                <div class="loading">
                    <span class="emoji-large">‚è≥</span>
                    Waiting for trade data...
                </div>
            </div>
        </div>
        
        <div class="last-update" id="last-update">
            Last update: Connecting...
        </div>
    </div>
    
    <script>
        let ws;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const API_URL = window.location.origin;
        let lastUpdateTime = Date.now();
        let pollingInterval;
        
        // WebSocket Connection
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                reconnectAttempts = 0;
                updateConnectionStatus(true);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('üì• WebSocket data:', data);
                    updateDashboard(data);
                } catch (error) {
                    console.error('‚ùå Error parsing message:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                updateConnectionStatus(false);
            };
            
            ws.onclose = () => {
                console.log('üîå WebSocket disconnected');
                updateConnectionStatus(false);
                
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * reconnectAttempts, 5000);
                    console.log(`üîÑ Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    setTimeout(connectWebSocket, delay);
                }
            };
        }
        
        // Polling Function (Every 2 seconds)
        async function pollStatus() {
            try {
                console.log('üîÑ Polling data...');
                const response = await fetch(`${API_URL}/api/status`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Polled data:', data);
                updateDashboard(data);
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('‚ùå Polling error:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Update Connection Status
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = '‚úÖ Connected';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = '‚ùå Disconnected';
            }
        }
        
        // Main Dashboard Update Function
        function updateDashboard(data) {
            lastUpdateTime = Date.now();
            
            // Status badge
            const statusBadge = document.getElementById('status-badge');
            if (data.running) {
                statusBadge.className = 'status-badge status-running';
                statusBadge.textContent = 'üü¢ RUNNING';
            } else {
                statusBadge.className = 'status-badge status-stopped';
                statusBadge.textContent = '‚è∏Ô∏è STOPPED';
            }
            
            // Balance & P&L
            if (data.balance !== undefined) {
                document.getElementById('balance').textContent = 
                    `$${data.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            if (data.pnl !== undefined) {
                const pnlEl = document.getElementById('pnl');
                const pnlValue = parseFloat(data.pnl);
                pnlEl.textContent = `${pnlValue >= 0 ? '+' : ''}$${Math.abs(pnlValue).toFixed(2)}`;
                pnlEl.className = pnlValue >= 0 ? 'pnl-positive' : 'pnl-negative';
            }
            
            // Price
            if (data.current_price && data.current_price.bid) {
                document.getElementById('price').textContent = `$${data.current_price.bid.toFixed(2)}`;
                document.getElementById('bid').textContent = data.current_price.bid.toFixed(2);
                document.getElementById('ask').textContent = data.current_price.ask.toFixed(2);
                document.getElementById('spread').textContent = data.current_price.spread.toFixed(2);
            }
            
            // Open Positions
            if (data.open_positions_count !== undefined) {
                document.getElementById('open-positions').textContent = data.open_positions_count;
            }
            
            // Signal
            const signalBadge = document.getElementById('signal-badge');
            const signal = data.last_signal || 'HOLD';
            signalBadge.textContent = signal;
            signalBadge.className = `signal-badge signal-${signal.toLowerCase()}`;
            
            // SMC Indicators
            if (data.smc_indicators) {
                document.getElementById('session').textContent = data.smc_indicators.session || 'CLOSED';
                document.getElementById('session-mini').textContent = data.smc_indicators.session || '-';
                document.getElementById('fvg-bullish').textContent = data.smc_indicators.fvg_bullish ? '‚úÖ' : '‚ùå';
                document.getElementById('fvg-bearish').textContent = data.smc_indicators.fvg_bearish ? '‚úÖ' : '‚ùå';
                document.getElementById('bos').textContent = data.smc_indicators.bos || 'None';
            }
            
            // Market Structure
            if (data.market_structure) {
                document.getElementById('market-structure').textContent = data.market_structure;
                document.getElementById('structure-mini').textContent = data.market_structure;
            }
            
            if (data.zone) {
                document.getElementById('zone').textContent = data.zone;
            }
            
            // Technical Levels
            if (data.technical_levels) {
                const levels = data.technical_levels;
                document.getElementById('ema200').textContent = `$${(levels.ema200 || 0).toFixed(2)}`;
                document.getElementById('ma20').textContent = `$${(levels.ma20 || 0).toFixed(2)}`;
                document.getElementById('ma50').textContent = `$${(levels.ma50 || 0).toFixed(2)}`;
                document.getElementById('support').textContent = `$${(levels.support || 0).toFixed(2)}`;
                document.getElementById('resistance').textContent = `$${(levels.resistance || 0).toFixed(2)}`;
                document.getElementById('atr').textContent = `$${(levels.atr || 0).toFixed(2)}`;
            }
            
            // Trade History
            if (data.trades && data.trades.length > 0) {
                const historyHTML = data.trades.slice(0, 15).map(trade => {
                    const pnlDisplay = trade.pnl !== undefined && trade.status === 'OPEN' 
                        ? `<div style="margin-top: 5px; font-weight: bold; color: ${trade.pnl >= 0 ? '#00ff00' : '#ff6b6b'};">
                             P&L: ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                           </div>`
                        : '';
                    
                    const lotDisplay = trade.lot_size > 0 ? `${trade.lot_size} lots` : '0.00 lots';
                    const statusClass = trade.status === 'OPEN' ? 'trade-open' : 'trade-signal';
                    
                    return `
                        <div class="trade-item trade-${trade.type.toLowerCase()} ${statusClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>#${trade.id} ${trade.type}</strong>
                                <span style="background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 5px; font-size: 0.9em;">
                                    ${lotDisplay}
                                </span>
                            </div>
                            <div style="margin-top: 8px;">
                                Entry: $${trade.entry.toFixed(2)}
                                ${trade.sl ? `| SL: $${trade.sl.toFixed(2)} | TP: $${trade.tp.toFixed(2)}` : ''}
                            </div>
                            ${pnlDisplay}
                            <div style="font-size: 0.85em; opacity: 0.7; margin-top: 8px; display: flex; justify-content: space-between;">
                                <span>${trade.time}</span>
                                <span style="font-weight: bold; color: ${trade.status === 'OPEN' ? '#00ff00' : '#ffaa00'};">
                                    ${trade.status}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('trade-history').innerHTML = historyHTML;
            } else {
                document.getElementById('trade-history').innerHTML = `
                    <div class="loading">
                        <span class="emoji-large">üìä</span>
                        No trades yet. Monitoring market...
                    </div>
                `;
            }
            
            // Last update
            const now = new Date();
            const timeString = now.toLocaleString('en-IN', { 
                timeZone: 'Asia/Kolkata',
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('last-update').textContent = `Last update: ${timeString} IST`;
            
            console.log('‚úÖ Dashboard updated successfully');
        }
        
        // Execute Manual Trade
        async function executeTrade(type) {
            const confirmed = confirm(`üîî Execute ${type.toUpperCase()} trade for 0.01 lots?\n\nThis will send a manual trade order.`);
            if (!confirmed) return;
            
            try {
                const response = await fetch(`${API_URL}/api/trade/manual?trade_type=${type}&lot_size=0.01`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(`‚úÖ ${type.toUpperCase()} trade executed successfully!\n\nEntry: $${result.trade.entry.toFixed(2)}\nLot Size: ${result.trade.lot_size}`);
                    // Immediate refresh after trade
                    pollStatus();
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                alert(`‚ùå Error executing trade: ${error.message}`);
                console.error('Trade error:', error);
            }
        }
        
        // Initialize Dashboard
        function initDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Try WebSocket connection
            connectWebSocket();
            
            // Start polling immediately
            pollStatus();
            
            // Set up polling interval (every 2 seconds)
            pollingInterval = setInterval(pollStatus, 2000);
            console.log('‚úÖ Polling started (every 2 seconds)');
        }
        
        // Check for stale data
        setInterval(() => {
            const timeSinceUpdate = Date.now() - lastUpdateTime;
            if (timeSinceUpdate > 10000) { // 10 seconds
                console.log('‚ö†Ô∏è Data is stale, forcing refresh...');
                pollStatus();
            }
        }, 5000);
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
            if (pollingInterval) clearInterval(pollingInterval);
        });
        
        // Prevent page from sleeping on mobile
        if ('wakeLock' in navigator) {
            let wakeLock = null;
            const requestWakeLock = async () => {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('üîí Wake Lock active');
                } catch (err) {
                    console.log('‚ö†Ô∏è Wake Lock error:', err);
                }
            };
            requestWakeLock();
        }
    </script>
</body>
</html>
